import crypto from "crypto";

const SECRET_KEY = "CHANGE_THIS_TO_LONG_RANDOM_SECRET";
const BOT_USERNAME = "YourBotUsername"; // without @

function verifyToken(token) {
  try {
    const raw = Buffer.from(token, "base64url").toString();
    const [data, signature] = raw.split(".");

    const expectedSig = crypto
      .createHmac("sha256", SECRET_KEY)
      .update(data)
      .digest("hex");

    if (signature !== expectedSig) return null;

    const payload = JSON.parse(data);

    // â³ Expiry check
    if (Date.now() / 1000 > payload.e) return null;

    return payload;
  } catch {
    return null;
  }
}

export default function handler(req, res) {
  const { token } = req.query;

  if (!token) {
    return res.status(403).send("âŒ Invalid Request");
  }

  const payload = verifyToken(token);
  if (!payload) {
    return res.status(403).send("âŒ Verification Failed or Expired");
  }

  // ğŸ›¡ Anti-bot User-Agent check
  const ua = (req.headers["user-agent"] || "").toLowerCase();
  const blocked = ["bot", "curl", "wget", "python", "httpx"];
  if (blocked.some(b => ua.includes(b))) {
    return res.status(403).send("âŒ Bot Access Denied");
  }

  const user_id = payload.u;

  // âœ… Redirect to Telegram
  res.writeHead(302, {
    Location: `https://t.me/${BOT_USERNAME}?start=verified_${user_id}`,
  });
  res.end();
}
